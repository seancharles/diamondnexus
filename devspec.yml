version: 0.2
phases:
  install:
    runtime-versions:
      python: 3.7
    commands:
      - python --version
  pre_build:
    commands:
      - export STARTTIME=`date +%s`
      - export BUILDNAME="$GIT_BRANCH-`date +%Y-%m-%d`"
      - export BRANCH="$GIT_BRANCH"
      - export SOURCE_VERSION="$CODEBUILD_SOURCE_VERSION"
      - export FUNCTION_NAME="$LAMBDA_TO_UPDATE"
      - export username="$GITUSER"
      - export pass="$GITPASSWORD"
      - export bucket="$BUCKETPATH"
      - export oauth="$GITOAUTH"
      - echo "BRANCH $BRANCH"
      - echo "SOURCE_VERSION $SOURCE_VERSION"
      - echo "username $GITUSER"
      - export task="$Taskid"
      - export accountId="$account"
  build:
    commands:
      - echo Build started on `date`
      - pwd
      - rm -rf *
      - ls
      - pwd
      - git clone https://$username:$pass@github.com/ForeverCompanies/magento2.git --branch develop
      - ls
      - cd magento2
      - git config --global --add remote.origin.fetch "+refs/pull/*/head:refs/remotes/origin/pr/*"
      - git config --global user.email "webdevlive@diamondnexus.com"
      - git config --global user.name "CI CD build"
      - chmod +x auto-repo-merge.sh
      - bash auto-repo-merge.sh
      - ls
      - ls
      - sleep 3
      - aws s3 sync . s3://mag2-dev-codebuild/magento --exclude ".git/*"  --delete
      - bash datasync.sh $task $accountId
      - sleep 3
      
  post_build:
    commands:
      - echo Build completed on `date`
      - pwd
      - ls -al
artifacts:
  files:
    - '**/*'
